  machine:
    environment:
      PROJECT_NAME: boxp-tk
      CLUSTER_NAME: alice
      CLOUDSDK_COMPUTE_ZONE: asia-northeast1-a
      DEBIAN_FRONTEND: noninteractive
      GOOGLE_APPLICATION_CREDENTIALS: ${HOME}/account-auth.json

    services:
      - docker

  dependencies:
    override:
      - sudo /opt/google-cloud-sdk/bin/gcloud components update --version 149.0.0;
      - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update kubectl --version 149.0.0;
      - echo $ACCT_AUTH | base64 --decode -i > ${HOME}/account-auth.json
      - sudo /opt/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file ${HOME}/account-auth.json
      - sudo /opt/google-cloud-sdk/bin/gcloud config set project $PROJECT_NAME
      - sudo /opt/google-cloud-sdk/bin/gcloud --quiet config set container/cluster $CLUSTER_NAME
      # Reading the zone from the env var is not working so we set it here
      - sudo /opt/google-cloud-sdk/bin/gcloud config set compute/zone ${CLOUDSDK_COMPUTE_ZONE}
      - sudo /opt/google-cloud-sdk/bin/gcloud --quiet container clusters get-credentials $CLUSTER_NAME
      - sudo /opt/google-cloud-sdk/bin/gcloud config set container/use_client_certificate True
      - docker run -it --rm -v "$PWD":/usr/src/app -w /usr/src/app clojure lein cljsbuild once min
      - docker build -t asia.gcr.io/${PROJECT_NAME}/shanghai:$CIRCLE_SHA1 .
      # Using a separate tag command until Docker 1.10 is available on CircleCI, then we can use two tags in the build command above
      - docker tag asia.gcr.io/${PROJECT_NAME}/shanghai:$CIRCLE_SHA1 asia.gcr.io/${PROJECT_NAME}/shanghai:latest

  test:
    override:
      - docker run -d -p 3000:80 asia.gcr.io/${PROJECT_NAME}/shanghai:$CIRCLE_SHA1; sleep 10
      - curl --retry 10 --retry-delay 5 -v http://localhost:3000
      - curl --retry 10 --retry-delay 5 -v http://localhost:3000/js/compiled/shanghai.js

  deployment:
    prod:
      branch: master
      commands:
        - ./deploy.sh
